{"version":3,"names":["_CursorBasedIterator","require","_OffsetBasedIterator","_PlatformizedQueryBuilder","_motionEdmAutogenCommon","_motionEdmAutogenTransformationsCore","_preset$query","preset","query","ITEMS_RESULT_PROPERTY_NAME","PAGING_METADATA_RESULT_PROPERTY_NAME","PagingMethods","constants","DEFAULT_LIMIT","PlatformizedQueryMethodWrapper","PlatformizedQueryBuilder","constructor","obj","func","requestTransformer","responseTransformer","errorTransformer","pagingMethod","cursor","builderOptions","find","options","_pagingMetadata$curso5","_pagingMetadata$curso6","_pagingMetadata$curso7","_pagingMetadata$curso8","_buildQuery","request","response","_this$responseTransfo","items","pagingMetadata","Offset","OffsetBasedIterator","fetchNextPage","_copyWithNextPage","fetchPrevPage","_copyWithPrevPage","offset","_pagingOffset","limit","_pagingLimit","totalCount","total","tooManyToCount","originQuery","CursorBasedIterator","_pagingMetadata$curso","_pagingMetadata$curso2","_copyWithCursor","cursors","next","_pagingMetadata$curso3","_pagingMetadata$curso4","prev","prevCursor","nextCursor","error","skipTo","queryObject","build","Cursor","_this$builderOptions","cursorWithEmptyFilterAndSort","cursorPaging","filter","sort","paging","undefined","_copyWithOffsetChange","amount","nextPage","exports","wrapWithQueryBuilder","transformationPaths"],"sources":["../../src/wrapWithQueryBuilder.ts"],"sourcesContent":["import { CursorBasedIterator } from './CursorBasedIterator';\nimport { OffsetBasedIterator } from './OffsetBasedIterator';\nimport { PlatformizedQueryBuilder } from './PlatformizedQueryBuilder';\nimport { constants } from '@wix/motion-edm-autogen-common';\nimport { preset } from '@wix/motion-edm-autogen-transformations-core';\n\nconst { ITEMS_RESULT_PROPERTY_NAME, PAGING_METADATA_RESULT_PROPERTY_NAME } =\n  preset.query;\nconst { PagingMethods } = constants;\n\nconst DEFAULT_LIMIT = 50;\n\nclass PlatformizedQueryMethodWrapper extends PlatformizedQueryBuilder {\n  constructor(obj) {\n    super(obj);\n    // Private variables cannot be prefixed with '_' here.\n    // That's because the filterMixin used by PlatformizedQueryBuilder copies its properties from \"this\"\n    // and passes them to the new instance ctor, that expects names without the '_' prefix.\n    // Changing this breaks the chaining capability.\n    this.func = obj.func;\n    this.requestTransformer = obj.requestTransformer;\n    this.responseTransformer = obj.responseTransformer;\n    this.errorTransformer = obj.errorTransformer;\n    this.pagingMethod = obj.pagingMethod;\n    this.cursor = obj.cursor;\n    this.builderOptions = obj.builderOptions;\n  }\n\n  async find(options = {}) {\n    try {\n      const query = this._buildQuery();\n      const request = this.requestTransformer(query, options);\n      const response = await this.func(request, {\n        ...options,\n        ...this.builderOptions,\n      });\n\n      const {\n        [ITEMS_RESULT_PROPERTY_NAME]: items,\n        [PAGING_METADATA_RESULT_PROPERTY_NAME]: pagingMetadata,\n      } = this.responseTransformer(response);\n\n      if (this.pagingMethod === PagingMethods.Offset) {\n        return new OffsetBasedIterator({\n          items,\n          fetchNextPage: () => this._copyWithNextPage().find(options),\n          fetchPrevPage: () => this._copyWithPrevPage().find(options),\n          offset: this._pagingOffset,\n          limit: this._pagingLimit,\n          totalCount: pagingMetadata?.total,\n          tooManyToCount: pagingMetadata?.tooManyToCount,\n          originQuery: this,\n        });\n      }\n\n      return new CursorBasedIterator({\n        items,\n        limit: this._pagingLimit,\n        originQuery: this,\n        fetchNextPage: () =>\n          this._copyWithCursor(pagingMetadata?.cursors?.next ?? '').find(\n            options,\n          ),\n        fetchPrevPage: () =>\n          this._copyWithCursor(pagingMetadata?.cursors?.prev ?? '').find(\n            options,\n          ),\n        prevCursor: pagingMetadata?.cursors?.prev ?? '',\n        nextCursor: pagingMetadata?.cursors?.next ?? '',\n      });\n    } catch (error) {\n      return this.errorTransformer(error);\n    }\n  }\n\n  skipTo(cursor) {\n    return this._copyWithCursor(cursor);\n  }\n\n  _copyWithCursor(cursor) {\n    return new PlatformizedQueryMethodWrapper({ ...this, cursor });\n  }\n\n  _buildQuery() {\n    const queryObject = this.build();\n\n    if (this.pagingMethod === PagingMethods.Cursor) {\n      if (this.builderOptions?.cursorWithEmptyFilterAndSort && this.cursor) {\n        return {\n          cursorPaging: { cursor: this.cursor, limit: this._pagingLimit },\n        };\n      }\n\n      return {\n        filter: queryObject.filter,\n        sort: this.sort,\n        cursorPaging: { cursor: this.cursor, limit: this._pagingLimit },\n      };\n    }\n\n    return {\n      filter: queryObject.filter,\n      sort: this.sort,\n      paging: { limit: this._pagingLimit, offset: this._pagingOffset },\n    };\n  }\n\n  get _pagingOffset() {\n    return this.paging.offset || 0;\n  }\n\n  get _pagingLimit() {\n    return this.paging.limit === undefined ? DEFAULT_LIMIT : this.paging.limit;\n  }\n\n  _copyWithOffsetChange(amount) {\n    const nextPage = {\n      offset: this._pagingOffset + amount,\n      limit: this._pagingLimit,\n    };\n\n    return new PlatformizedQueryMethodWrapper({ ...this, paging: nextPage });\n  }\n\n  _copyWithNextPage() {\n    return this._copyWithOffsetChange(this._pagingLimit);\n  }\n\n  _copyWithPrevPage() {\n    return this._copyWithOffsetChange(-this._pagingLimit);\n  }\n}\n\ninterface WrapWithQueryBuilderOptions {\n  func: any;\n  requestTransformer: any;\n  responseTransformer: any;\n  errorTransformer: any;\n  pagingMethod: any;\n  transformationPaths: any;\n  cursor?: any;\n}\n\nconst wrapWithQueryBuilder =\n  ({\n    func,\n    requestTransformer,\n    responseTransformer,\n    errorTransformer,\n    pagingMethod,\n    transformationPaths,\n    cursor = undefined,\n  }: WrapWithQueryBuilderOptions) =>\n  (builderOptions = {}) =>\n    new PlatformizedQueryMethodWrapper({\n      func,\n      builderOptions,\n      requestTransformer,\n      responseTransformer,\n      errorTransformer,\n      pagingMethod,\n      transformationPaths,\n      cursor,\n    });\n\nexport { wrapWithQueryBuilder, PlatformizedQueryMethodWrapper };\n"],"mappings":"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"}