{"version":3,"names":["_querystring","_interopRequireDefault","require","_toAltText","WIX_IMAGE_PROTOCOL","WIX_LEGACY_IMAGE_PROTOCOL","WIX_IMAGE_PROTOCOL_SUFFIX","URL_HASH_PREFIX","DEFAULT_IMAGE_FILE_NAME","alignIfLegacyImage","image","_URL","URL","protocol","corvidToP13n","undefined","alignedImage","_URL2","hash","pathname","_querystring$parse","querystring","parse","replace","height","originHeight","width","originWidth","_pathname$replace$spl","split","id","filename","Number","altText","toAltText","url","exports","computeImageFileName","_image$altText","encodeURIComponent","p13nToCorvid"],"sources":["../../../src/image/index.ts"],"sourcesContent":["import querystring from 'querystring';\nimport { responses } from '../proto-generated/server';\nimport { toAltText } from './toAltText';\n\ntype IImage = responses.wix.common.IImage;\n\nconst WIX_IMAGE_PROTOCOL = 'wix:';\nconst WIX_LEGACY_IMAGE_PROTOCOL = 'image:';\nconst WIX_IMAGE_PROTOCOL_SUFFIX = 'image://v1/';\nconst URL_HASH_PREFIX = '#';\n\nconst DEFAULT_IMAGE_FILE_NAME = 'file';\n\nconst alignIfLegacyImage = (image: string): string => {\n  const { protocol } = new URL(image);\n\n  return protocol === WIX_LEGACY_IMAGE_PROTOCOL ? `wix:${image}` : image;\n};\n\nconst corvidToP13n = (image?: string | null): undefined | IImage => {\n  if (!image) {\n    return undefined;\n  }\n\n  const alignedImage = alignIfLegacyImage(image);\n\n  const { protocol, hash, pathname } = new URL(alignedImage);\n  const { originHeight: height, originWidth: width } = querystring.parse(\n    hash.replace(URL_HASH_PREFIX, ''),\n  );\n  const [id, filename] = pathname\n    .replace(WIX_IMAGE_PROTOCOL_SUFFIX, '')\n    .split('/');\n\n  if (protocol === WIX_IMAGE_PROTOCOL) {\n    return {\n      id,\n      height: Number(height),\n      width: Number(width),\n      altText: toAltText(filename),\n    };\n  }\n\n  return { url: image };\n};\n\nconst computeImageFileName = (image: IImage) => {\n  const filename = image.altText ?? DEFAULT_IMAGE_FILE_NAME;\n\n  return encodeURIComponent(filename);\n};\n\nconst p13nToCorvid = (image?: IImage | null): undefined | string => {\n  if (!image) {\n    return undefined;\n  }\n\n  return image.id\n    ? `wix:image://v1/${image.id}/${computeImageFileName(\n        image,\n      )}#originWidth=${image.width!}&originHeight=${image.height!}`\n    : image?.url;\n};\n\nexport { corvidToP13n, p13nToCorvid };\n"],"mappings":";;;;;AAAA,IAAAA,YAAA,GAAAC,sBAAA,CAAAC,OAAA;AAEA,IAAAC,UAAA,GAAAD,OAAA;AAIA,MAAME,kBAAkB,GAAG,MAAM;AACjC,MAAMC,yBAAyB,GAAG,QAAQ;AAC1C,MAAMC,yBAAyB,GAAG,aAAa;AAC/C,MAAMC,eAAe,GAAG,GAAG;AAE3B,MAAMC,uBAAuB,GAAG,MAAM;AAEtC,MAAMC,kBAAkB,GAAIC,KAAa,IAAa;EACpD,MAAAC,IAAA,GAAqB,IAAIC,GAAG,CAACF,KAAK,CAAC;IAA3BG,QAAQ,GAAAF,IAAA,CAARE,QAAQ;EAEhB,OAAOA,QAAQ,KAAKR,yBAAyB,GAAI,OAAMK,KAAM,EAAC,GAAGA,KAAK;AACxE,CAAC;AAED,MAAMI,YAAY,GAAIJ,KAAqB,IAAyB;EAClE,IAAI,CAACA,KAAK,EAAE;IACV,OAAOK,SAAS;EAClB;EAEA,MAAMC,YAAY,GAAGP,kBAAkB,CAACC,KAAK,CAAC;EAE9C,MAAAO,KAAA,GAAqC,IAAIL,GAAG,CAACI,YAAY,CAAC;IAAlDH,QAAQ,GAAAI,KAAA,CAARJ,QAAQ;IAAEK,IAAI,GAAAD,KAAA,CAAJC,IAAI;IAAEC,QAAQ,GAAAF,KAAA,CAARE,QAAQ;EAChC,MAAAC,kBAAA,GAAqDC,oBAAW,CAACC,KAAK,CACpEJ,IAAI,CAACK,OAAO,CAAChB,eAAe,EAAE,EAAE,CAClC,CAAC;IAFqBiB,MAAM,GAAAJ,kBAAA,CAApBK,YAAY;IAAuBC,KAAK,GAAAN,kBAAA,CAAlBO,WAAW;EAGzC,MAAAC,qBAAA,GAAuBT,QAAQ,CAC5BI,OAAO,CAACjB,yBAAyB,EAAE,EAAE,CAAC,CACtCuB,KAAK,CAAC,GAAG,CAAC;IAFNC,EAAE,GAAAF,qBAAA;IAAEG,QAAQ,GAAAH,qBAAA;EAInB,IAAIf,QAAQ,KAAKT,kBAAkB,EAAE;IACnC,OAAO;MACL0B,EAAE;MACFN,MAAM,EAAEQ,MAAM,CAACR,MAAM,CAAC;MACtBE,KAAK,EAAEM,MAAM,CAACN,KAAK,CAAC;MACpBO,OAAO,EAAE,IAAAC,oBAAS,EAACH,QAAQ;IAC7B,CAAC;EACH;EAEA,OAAO;IAAEI,GAAG,EAAEzB;EAAM,CAAC;AACvB,CAAC;AAAC0B,OAAA,CAAAtB,YAAA,GAAAA,YAAA;AAEF,MAAMuB,oBAAoB,GAAI3B,KAAa,IAAK;EAAA,IAAA4B,cAAA;EAC9C,MAAMP,QAAQ,IAAAO,cAAA,GAAG5B,KAAK,CAACuB,OAAO,YAAAK,cAAA,GAAI9B,uBAAuB;EAEzD,OAAO+B,kBAAkB,CAACR,QAAQ,CAAC;AACrC,CAAC;AAED,MAAMS,YAAY,GAAI9B,KAAqB,IAAyB;EAClE,IAAI,CAACA,KAAK,EAAE;IACV,OAAOK,SAAS;EAClB;EAEA,OAAOL,KAAK,CAACoB,EAAE,GACV,kBAAiBpB,KAAK,CAACoB,EAAG,IAAGO,oBAAoB,CAChD3B,KACF,CAAE,gBAAeA,KAAK,CAACgB,KAAO,iBAAgBhB,KAAK,CAACc,MAAQ,EAAC,GAC7Dd,KAAK,oBAALA,KAAK,CAAEyB,GAAG;AAChB,CAAC;AAACC,OAAA,CAAAI,YAAA,GAAAA,YAAA"}