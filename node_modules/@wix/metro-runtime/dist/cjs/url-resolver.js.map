{"version":3,"names":["_utils","require","USER_DOMAIN","DOMAINS","WIX_API_DOMAINS","DEV_WIX_CODE_DOMAIN","REGEX_CAPTURE_PROTO_FIELD","REGEX_CAPTURE_DOMAINS","RegExp","join","REGEX_CAPTURE_API_DOMAINS","REGEX_CAPTURE_DEV_WIX_CODE_DOMAIN","resolveUrl","opts","domain","resolveDomain","host","mappings","resolveMappingsByDomain","domainToMappings","path","injectDataIntoProtoPath","protoPath","data","resolvePath","split","map","maybeProtoPathToData","protoRegExpMatch","match","field","suffix","replace","findByPath","resolvedHost","fixHostExceptions","isBaseDomain","wwwBaseDomain","mapping","find","m","startsWith","destPath","srcPath","slice","length"],"sources":["../../src/url-resolver.ts"],"sourcesContent":["import { findByPath } from './utils';\n\nconst USER_DOMAIN = '_';\n\nconst DOMAINS = ['wix.com', 'editorx.com'];\n\nconst WIX_API_DOMAINS = ['42.wixprod.net', 'uw2-edt-1.wixprod.net'];\n\nconst DEV_WIX_CODE_DOMAIN = 'dev.wix-code.com';\n\nconst REGEX_CAPTURE_PROTO_FIELD = /{(.*)}/;\n\nconst REGEX_CAPTURE_DOMAINS = new RegExp(`\\\\.(${DOMAINS.join('|')})$`);\n\nconst REGEX_CAPTURE_API_DOMAINS = new RegExp(\n  `\\\\.(${WIX_API_DOMAINS.join('|')})$`,\n);\n\nconst REGEX_CAPTURE_DEV_WIX_CODE_DOMAIN = new RegExp(\n  `.*\\\\.${DEV_WIX_CODE_DOMAIN}$`,\n);\n\nexport type ResolveUrlOpts = {\n  // resource path as defined in proto file, including all wildcards & co.\n  protoPath: string;\n\n  // domain as defined on FP to its mappings (might be more than one)\n  // www._base_domain_ => [{ srcPath: '/_api/foo', destPath: '/api' }]\n  domainToMappings: DomainToMappings;\n\n  // actual payload attached to request, needed in order to rersolve path,\n  // in case it conatins some dynamic parameters\n  data?: object;\n\n  // request's host\n  host: string;\n};\n\nexport function resolveUrl(opts: ResolveUrlOpts) {\n  const domain = resolveDomain(opts.host);\n  const mappings = resolveMappingsByDomain(domain, opts.domainToMappings);\n  const path = injectDataIntoProtoPath(opts.protoPath, opts.data || {});\n\n  return resolvePath(path, mappings);\n}\n\nfunction injectDataIntoProtoPath(protoPath: string, data: object) {\n  return protoPath\n    .split('/')\n    .map((path) => maybeProtoPathToData(path, data))\n    .join('/');\n}\n\nfunction maybeProtoPathToData(protoPath: string, data: object) {\n  const protoRegExpMatch = protoPath.match(REGEX_CAPTURE_PROTO_FIELD) || [];\n\n  const field = protoRegExpMatch[1];\n\n  if (field) {\n    const suffix = protoPath.replace(protoRegExpMatch[0]!, '');\n    return findByPath(data, field, protoPath, suffix);\n  }\n\n  return protoPath;\n}\n\nfunction resolveDomain(host: string) {\n  const resolvedHost = fixHostExceptions(host);\n\n  return resolvedHost\n    .replace(REGEX_CAPTURE_DOMAINS, '._base_domain_')\n    .replace(REGEX_CAPTURE_API_DOMAINS, '._api_base_domain_')\n    .replace(REGEX_CAPTURE_DEV_WIX_CODE_DOMAIN, '*.dev.wix-code.com');\n}\n\n// hosts which standard string replacing doesn't apply to them, will be fixed here.\nfunction fixHostExceptions(host: string) {\n  // https://system-kb.wixanswers.com/kb/en/article/editorx-domains-matching-to-wixcom\n  return host.replace('create.editorx.com', 'editor.editorx.com');\n}\n\nfunction resolveMappingsByDomain(\n  domain: string,\n  domainToMappings: DomainToMappings,\n) {\n  const mappings = domainToMappings[domain] || domainToMappings[USER_DOMAIN];\n\n  if (!mappings) {\n    if (isBaseDomain(domain)) {\n      // fallback <lang>.wix.com sub domains to www.wix.com\n      // since all of the languages subdomain are not mapped automatically in FP and we want to support those kind of calls\n      // for example: fr.wix.com\n      return domainToMappings[wwwBaseDomain];\n    }\n  }\n\n  return mappings;\n}\n\nfunction resolvePath(protoPath: string, mappings: Mapping[]) {\n  const mapping = mappings?.find((m) => protoPath.startsWith(m.destPath));\n\n  if (!mapping) {\n    // todo: should we return the path? if no - what should we do in case of testings?\n    return protoPath;\n  }\n\n  return mapping.srcPath + protoPath.slice(mapping.destPath.length);\n}\n\ntype Mapping = {\n  srcPath: string;\n  destPath: string;\n};\n\ntype DomainToMappings = Record<string, Mapping[]>;\n\nfunction isBaseDomain(domain: string) {\n  return !!domain.match(/\\._base_domain_$/);\n}\n\nconst wwwBaseDomain = 'www._base_domain_';\n"],"mappings":"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"}