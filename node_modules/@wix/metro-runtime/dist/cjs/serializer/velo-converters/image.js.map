{"version":3,"names":["_querystring","_interopRequireDefault","require","_domain","_convertersUtils","WIX_IMAGE","image","types","ConverterType","FROM_JSON","transform","val","fileNameOrAltText","filename","altText","encodeText","id","URL_HASH_PREFIX","width","height","url","TO_JSON","alignedImage","alignIfLegacy","_URL","URL","protocol","hash","pathname","_querystring$parse","querystring","parse","replace","originHeight","originWidth","_pathname$replace$spl","split","filenameOrAltText","decodedFilenameOrAltText","decodeText","WIX_PROTOCOL","res","Number","exports"],"sources":["../../../../src/serializer/velo-converters/image.ts"],"sourcesContent":["import querystring from 'querystring';\nimport type com from '../../proto';\nimport { ConverterSet, ConverterType } from '../domain';\nimport {\n  alignIfLegacy,\n  encodeText,\n  decodeText,\n  URL_HASH_PREFIX,\n  WIX_PROTOCOL,\n} from './converters-utils';\n\nconst WIX_IMAGE = 'image';\n\nexport const image: ConverterSet = {\n  types: ['wix.common.Image'],\n\n  [ConverterType.FROM_JSON]: {\n    /**\n     * currently wix.common.Image represents the deserialized object, so we're good.\n     * in case it contains some serializable stuff (e.g. int64), we'll have to make some\n     * modifications in the type.\n     */\n    transform: (val: com.wix.common.Image) => {\n      if (!val) {\n        return;\n      }\n\n      let fileNameOrAltText = '';\n      if (val.filename || val.altText) {\n        fileNameOrAltText = `/${encodeText(val.filename || val.altText)}`;\n      }\n\n      return val.id\n        ? `wix:image://v1/${val.id}${fileNameOrAltText}${URL_HASH_PREFIX}originWidth=${val.width}&originHeight=${val.height}`\n        : val.url;\n    },\n  },\n\n  [ConverterType.TO_JSON]: {\n    transform: (val: string): com.wix.common.Image | undefined => {\n      if (!val) {\n        return;\n      }\n\n      const alignedImage = alignIfLegacy(val, WIX_IMAGE);\n\n      const { protocol, hash, pathname } = new URL(alignedImage);\n\n      const { originHeight: height, originWidth: width } = querystring.parse(\n        hash.replace(URL_HASH_PREFIX, ''),\n      );\n      const [id, filenameOrAltText] = pathname\n        .replace(`${WIX_IMAGE}://v1/`, '')\n        .split('/');\n\n      const decodedFilenameOrAltText = decodeText(filenameOrAltText);\n\n      if (protocol === WIX_PROTOCOL) {\n        const res = { id, height: Number(height), width: Number(width) };\n\n        if (!decodedFilenameOrAltText) {\n          return res;\n        }\n\n        return {\n          ...res,\n          altText: decodedFilenameOrAltText,\n          filename: decodedFilenameOrAltText,\n        };\n      }\n\n      return { url: val };\n    },\n  },\n};\n"],"mappings":";;;;;AAAA,IAAAA,YAAA,GAAAC,sBAAA,CAAAC,OAAA;AAEA,IAAAC,OAAA,GAAAD,OAAA;AACA,IAAAE,gBAAA,GAAAF,OAAA;AAQA,MAAMG,SAAS,GAAG,OAAO;AAElB,MAAMC,KAAmB,GAAG;EACjCC,KAAK,EAAE,CAAC,kBAAkB,CAAC;EAE3B,CAACC,qBAAa,CAACC,SAAS,GAAG;IACzB;AACJ;AACA;AACA;AACA;IACIC,SAAS,EAAGC,GAAyB,IAAK;MACxC,IAAI,CAACA,GAAG,EAAE;QACR;MACF;MAEA,IAAIC,iBAAiB,GAAG,EAAE;MAC1B,IAAID,GAAG,CAACE,QAAQ,IAAIF,GAAG,CAACG,OAAO,EAAE;QAC/BF,iBAAiB,GAAI,IAAG,IAAAG,2BAAU,EAACJ,GAAG,CAACE,QAAQ,IAAIF,GAAG,CAACG,OAAO,CAAE,EAAC;MACnE;MAEA,OAAOH,GAAG,CAACK,EAAE,GACR,kBAAiBL,GAAG,CAACK,EAAG,GAAEJ,iBAAkB,GAAEK,gCAAgB,eAAcN,GAAG,CAACO,KAAM,iBAAgBP,GAAG,CAACQ,MAAO,EAAC,GACnHR,GAAG,CAACS,GAAG;IACb;EACF,CAAC;EAED,CAACZ,qBAAa,CAACa,OAAO,GAAG;IACvBX,SAAS,EAAGC,GAAW,IAAuC;MAC5D,IAAI,CAACA,GAAG,EAAE;QACR;MACF;MAEA,MAAMW,YAAY,GAAG,IAAAC,8BAAa,EAACZ,GAAG,EAAEN,SAAS,CAAC;MAElD,MAAAmB,IAAA,GAAqC,IAAIC,GAAG,CAACH,YAAY,CAAC;QAAlDI,QAAQ,GAAAF,IAAA,CAARE,QAAQ;QAAEC,IAAI,GAAAH,IAAA,CAAJG,IAAI;QAAEC,QAAQ,GAAAJ,IAAA,CAARI,QAAQ;MAEhC,MAAAC,kBAAA,GAAqDC,oBAAW,CAACC,KAAK,CACpEJ,IAAI,CAACK,OAAO,CAACf,gCAAe,EAAE,EAAE,CAClC,CAAC;QAFqBE,MAAM,GAAAU,kBAAA,CAApBI,YAAY;QAAuBf,KAAK,GAAAW,kBAAA,CAAlBK,WAAW;MAGzC,MAAAC,qBAAA,GAAgCP,QAAQ,CACrCI,OAAO,CAAE,GAAE3B,SAAU,QAAO,EAAE,EAAE,CAAC,CACjC+B,KAAK,CAAC,GAAG,CAAC;QAFNpB,EAAE,GAAAmB,qBAAA;QAAEE,iBAAiB,GAAAF,qBAAA;MAI5B,MAAMG,wBAAwB,GAAG,IAAAC,2BAAU,EAACF,iBAAiB,CAAC;MAE9D,IAAIX,QAAQ,KAAKc,6BAAY,EAAE;QAC7B,MAAMC,GAAG,GAAG;UAAEzB,EAAE;UAAEG,MAAM,EAAEuB,MAAM,CAACvB,MAAM,CAAC;UAAED,KAAK,EAAEwB,MAAM,CAACxB,KAAK;QAAE,CAAC;QAEhE,IAAI,CAACoB,wBAAwB,EAAE;UAC7B,OAAOG,GAAG;QACZ;QAEA,OAAO;UACL,GAAGA,GAAG;UACN3B,OAAO,EAAEwB,wBAAwB;UACjCzB,QAAQ,EAAEyB;QACZ,CAAC;MACH;MAEA,OAAO;QAAElB,GAAG,EAAET;MAAI,CAAC;IACrB;EACF;AACF,CAAC;AAACgC,OAAA,CAAArC,KAAA,GAAAA,KAAA"}