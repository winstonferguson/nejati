{"version":3,"names":["_querystring","_interopRequireDefault","require","_domain","_convertersUtils","WIX_VIDEO","videoV2","types","ConverterType","FROM_JSON","transform","val","_val$posters","fileName","filename","encodeText","posterData","posters","length","_val$posters2","poster1","poster2","poster","posterId","id","url","idx","lastIndexOf","substring","URL_HASH_PREFIX","width","height","TO_JSON","alignedVideo","alignIfLegacy","_URL","URL","protocol","hash","pathname","_querystring$parse","querystring","parse","replace","posterHeight","posterWidth","posterUri","_pathname$replace$spl","split","WIX_PROTOCOL","res","decodeText","toString","Number","exports"],"sources":["../../../../src/serializer/velo-converters/video-v2.ts"],"sourcesContent":["import querystring from 'querystring';\nimport type com from '../../proto';\nimport { ConverterSet, ConverterType } from '../domain';\nimport {\n  alignIfLegacy,\n  decodeText,\n  encodeText,\n  URL_HASH_PREFIX,\n  WIX_PROTOCOL,\n} from './converters-utils';\n\nconst WIX_VIDEO = 'video';\n\nexport const videoV2: ConverterSet = {\n  types: ['wix.common.VideoV2'],\n\n  [ConverterType.FROM_JSON]: {\n    transform: (val: com.wix.common.VideoV2) => {\n      if (!val) {\n        return;\n      }\n\n      let fileName = '';\n\n      if (val?.filename) {\n        fileName = `/${encodeText(val.filename)}`;\n      }\n\n      let posterData = '';\n      if (val.posters?.length) {\n        const [poster1, poster2] = val.posters;\n        const poster = poster2 || poster1;\n\n        let posterId: string = poster.id || '';\n        if (!posterId && poster.url) {\n          const idx = poster.url.lastIndexOf('/');\n          if (idx !== -1) {\n            posterId = poster.url.substring(idx + 1);\n          }\n        }\n\n        if (posterId) {\n          posterData = `${URL_HASH_PREFIX}posterUri=${posterId}&posterWidth=${\n            poster!.width\n          }&posterHeight=${poster!.height}`;\n        }\n      }\n\n      return val.id\n        ? `wix:video://v1/${val.id}${fileName}${posterData}`\n        : val.url;\n    },\n  },\n\n  [ConverterType.TO_JSON]: {\n    transform: (val: string): com.wix.common.VideoV2 | undefined => {\n      if (!val) {\n        return;\n      }\n\n      const alignedVideo = alignIfLegacy(val, WIX_VIDEO);\n\n      const { protocol, hash, pathname } = new URL(alignedVideo);\n      const {\n        posterHeight: height,\n        posterWidth: width,\n        posterUri,\n      } = querystring.parse(hash.replace(URL_HASH_PREFIX, ''));\n      const [id, fileName] = pathname\n        .replace(`${WIX_VIDEO}://v1/`, '')\n        .split('/');\n\n      if (protocol === WIX_PROTOCOL) {\n        let res: com.wix.common.VideoV2 = { id };\n\n        if (fileName) {\n          res = { ...res, filename: decodeText(fileName) };\n        }\n\n        if (!posterUri) {\n          return res;\n        }\n\n        return {\n          ...res,\n          posters: [\n            {\n              id: posterUri.toString(),\n              height: Number(height),\n              width: Number(width),\n            },\n          ],\n        };\n      }\n      return { url: val };\n    },\n  },\n};\n"],"mappings":";;;;;AAAA,IAAAA,YAAA,GAAAC,sBAAA,CAAAC,OAAA;AAEA,IAAAC,OAAA,GAAAD,OAAA;AACA,IAAAE,gBAAA,GAAAF,OAAA;AAQA,MAAMG,SAAS,GAAG,OAAO;AAElB,MAAMC,OAAqB,GAAG;EACnCC,KAAK,EAAE,CAAC,oBAAoB,CAAC;EAE7B,CAACC,qBAAa,CAACC,SAAS,GAAG;IACzBC,SAAS,EAAGC,GAA2B,IAAK;MAAA,IAAAC,YAAA;MAC1C,IAAI,CAACD,GAAG,EAAE;QACR;MACF;MAEA,IAAIE,QAAQ,GAAG,EAAE;MAEjB,IAAIF,GAAG,YAAHA,GAAG,CAAEG,QAAQ,EAAE;QACjBD,QAAQ,GAAI,IAAG,IAAAE,2BAAU,EAACJ,GAAG,CAACG,QAAQ,CAAE,EAAC;MAC3C;MAEA,IAAIE,UAAU,GAAG,EAAE;MACnB,KAAAJ,YAAA,GAAID,GAAG,CAACM,OAAO,aAAXL,YAAA,CAAaM,MAAM,EAAE;QACvB,MAAAC,aAAA,GAA2BR,GAAG,CAACM,OAAO;UAA/BG,OAAO,GAAAD,aAAA;UAAEE,OAAO,GAAAF,aAAA;QACvB,MAAMG,MAAM,GAAGD,OAAO,IAAID,OAAO;QAEjC,IAAIG,QAAgB,GAAGD,MAAM,CAACE,EAAE,IAAI,EAAE;QACtC,IAAI,CAACD,QAAQ,IAAID,MAAM,CAACG,GAAG,EAAE;UAC3B,MAAMC,GAAG,GAAGJ,MAAM,CAACG,GAAG,CAACE,WAAW,CAAC,GAAG,CAAC;UACvC,IAAID,GAAG,KAAK,CAAC,CAAC,EAAE;YACdH,QAAQ,GAAGD,MAAM,CAACG,GAAG,CAACG,SAAS,CAACF,GAAG,GAAG,CAAC,CAAC;UAC1C;QACF;QAEA,IAAIH,QAAQ,EAAE;UACZP,UAAU,GAAI,GAAEa,gCAAgB,aAAYN,QAAS,gBACnDD,MAAM,CAAEQ,KACT,iBAAgBR,MAAM,CAAES,MAAO,EAAC;QACnC;MACF;MAEA,OAAOpB,GAAG,CAACa,EAAE,GACR,kBAAiBb,GAAG,CAACa,EAAG,GAAEX,QAAS,GAAEG,UAAW,EAAC,GAClDL,GAAG,CAACc,GAAG;IACb;EACF,CAAC;EAED,CAACjB,qBAAa,CAACwB,OAAO,GAAG;IACvBtB,SAAS,EAAGC,GAAW,IAAyC;MAC9D,IAAI,CAACA,GAAG,EAAE;QACR;MACF;MAEA,MAAMsB,YAAY,GAAG,IAAAC,8BAAa,EAACvB,GAAG,EAAEN,SAAS,CAAC;MAElD,MAAA8B,IAAA,GAAqC,IAAIC,GAAG,CAACH,YAAY,CAAC;QAAlDI,QAAQ,GAAAF,IAAA,CAARE,QAAQ;QAAEC,IAAI,GAAAH,IAAA,CAAJG,IAAI;QAAEC,QAAQ,GAAAJ,IAAA,CAARI,QAAQ;MAChC,MAAAC,kBAAA,GAIIC,oBAAW,CAACC,KAAK,CAACJ,IAAI,CAACK,OAAO,CAACd,gCAAe,EAAE,EAAE,CAAC,CAAC;QAHxCE,MAAM,GAAAS,kBAAA,CAApBI,YAAY;QACCd,KAAK,GAAAU,kBAAA,CAAlBK,WAAW;QACXC,SAAS,GAAAN,kBAAA,CAATM,SAAS;MAEX,MAAAC,qBAAA,GAAuBR,QAAQ,CAC5BI,OAAO,CAAE,GAAEtC,SAAU,QAAO,EAAE,EAAE,CAAC,CACjC2C,KAAK,CAAC,GAAG,CAAC;QAFNxB,EAAE,GAAAuB,qBAAA;QAAElC,QAAQ,GAAAkC,qBAAA;MAInB,IAAIV,QAAQ,KAAKY,6BAAY,EAAE;QAC7B,IAAIC,GAA2B,GAAG;UAAE1B;QAAG,CAAC;QAExC,IAAIX,QAAQ,EAAE;UACZqC,GAAG,GAAG;YAAE,GAAGA,GAAG;YAAEpC,QAAQ,EAAE,IAAAqC,2BAAU,EAACtC,QAAQ;UAAE,CAAC;QAClD;QAEA,IAAI,CAACiC,SAAS,EAAE;UACd,OAAOI,GAAG;QACZ;QAEA,OAAO;UACL,GAAGA,GAAG;UACNjC,OAAO,EAAE,CACP;YACEO,EAAE,EAAEsB,SAAS,CAACM,QAAQ,CAAC,CAAC;YACxBrB,MAAM,EAAEsB,MAAM,CAACtB,MAAM,CAAC;YACtBD,KAAK,EAAEuB,MAAM,CAACvB,KAAK;UACrB,CAAC;QAEL,CAAC;MACH;MACA,OAAO;QAAEL,GAAG,EAAEd;MAAI,CAAC;IACrB;EACF;AACF,CAAC;AAAC2C,OAAA,CAAAhD,OAAA,GAAAA,OAAA"}